{% extends 'core/base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}{{ contest.title }} - Problems{% endblock %}

{% block content %}
<div class="card-section">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="card-title mb-0">{{ contest.title }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'contest_list' %}">Contests</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'contest_detail' contest.uuid %}">{{ contest.title }}</a></li>
                    <li class="breadcrumb-item active">Problems</li>
                </ol>
            </nav>
        </div>
        
        <div class="d-flex gap-2">
            {% if contest.is_running %}
                <span class="badge bg-success">Contest Running</span>
            {% else %}
                <span class="badge bg-secondary">Contest Ended</span>
            {% endif %}
        </div>
    </div>

    <!-- Navigation -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link" href="{% url 'contest_detail' contest.uuid %}">Overview</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" href="{% url 'contest_problems' contest.uuid %}">Problems</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'contest_standings' contest.uuid %}">Standings</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'contest_announcements' contest.uuid %}">Announcements</a>
        </li>
    </ul>

    <!-- Problems List -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th style="width: 5%">#</th>
                    <th style="width: 45%">Problem</th>
                    <th style="width: 15%">Points</th>
                    <th style="width: 20%">Status</th>
                    <th style="width: 15%">Submissions</th>
                </tr>
            </thead>
            <tbody>
                {% for contest_problem in contest_problems %}
                <tr>
                    <td class="text-center">
                        <strong>{{ contest_problem.order }}</strong>
                    </td>
                    <td>
                        <a href="{% url 'contest_problem_detail' contest.uuid contest_problem.problem.uuid %}" 
                           class="text-decoration-none">
                            <strong>{{ contest_problem.problem.title }}</strong>
                        </a>
                        
                        {% if contest_problem.problem.tags %}
                        <div class="mt-1">
                            {% for tag in contest_problem.problem.tags|split:"," %}
                            <span class="badge bg-light text-dark me-1">{{ tag.strip }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge bg-primary">{{ contest_problem.points }} pts</span>
                    </td>
                    <td>
                        {% with user_submissions|default_if_none:''|get_item:contest_problem.problem.uuid as submissions %}
                            {% if submissions %}
                                {% with submissions|first as latest_submission %}
                                    {% if latest_submission.verdict == 'AC' %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle me-1"></i>Accepted
                                        </span>
                                    {% elif latest_submission.verdict == 'WA' %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle me-1"></i>Wrong Answer
                                        </span>
                                    {% elif latest_submission.verdict == 'TLE' %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-clock me-1"></i>Time Limit
                                        </span>
                                    {% elif latest_submission.verdict == 'RE' %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-exclamation-triangle me-1"></i>Runtime Error
                                        </span>
                                    {% elif latest_submission.verdict == 'CE' %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-gear me-1"></i>Compile Error
                                        </span>
                                    {% elif latest_submission.verdict == 'MLE' %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-memory me-1"></i>Memory Limit
                                        </span>
                                    {% elif latest_submission.verdict == 'PE' %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-file-text me-1"></i>Presentation Error
                                        </span>
                                    {% elif latest_submission.verdict == 'OLE' %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-file-text me-1"></i>Output Limit
                                        </span>
                                    {% elif latest_submission.verdict == 'IE' %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-exclamation-triangle me-1"></i>Internal Error
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            {{ latest_submission.verdict }}
                                        </span>
                                    {% endif %}
                                {% endwith %}
                            {% else %}
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-dash-circle me-1"></i>Not Attempted
                                </span>
                            {% endif %}
                        {% endwith %}
                    </td>
                    <td>
                        {% with user_submissions|default_if_none:''|get_item:contest_problem.problem.uuid as submissions %}
                            {% if submissions %}
                                <span class="text-muted">{{ submissions|length }} submission{{ submissions|length|pluralize }}</span>
                            {% else %}
                                <span class="text-muted">0 submissions</span>
                            {% endif %}
                        {% endwith %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                        <p class="text-muted mt-2">No problems in this contest yet.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Contest Status Info -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contest Information</h5>
                    <div class="row">
                        <div class="col-6">
                            <strong>Start Time:</strong><br>
                            <small>{{ contest.start_time|date:"M d, Y H:i" }}</small>
                        </div>
                        <div class="col-6">
                            <strong>End Time:</strong><br>
                            <small>{{ contest.end_time|date:"M d, Y H:i" }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Your Progress</h5>
                    <div class="row">
                        <div class="col-6">
                            <strong>Problems Solved:</strong><br>
                            <span class="text-success">
                                {{ progress_stats.accepted_problems }} / {{ progress_stats.total_problems }}
                            </span>
                        </div>
                        <div class="col-6">
                            <strong>Total Submissions:</strong><br>
                            <span class="text-primary">{{ progress_stats.total_submissions }}</span>
                        </div>
                    </div>
                    
                    <!-- Progress bar -->
                    {% if progress_stats.total_problems > 0 %}
                    <div class="mt-3">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Progress</span>
                            <span>{{ progress_stats.accepted_problems }}/{{ progress_stats.total_problems }}</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            {% widthratio progress_stats.accepted_problems progress_stats.total_problems 100 as progress_percentage %}
                            <div class="progress-bar bg-success progress-bar-dynamic" 
                                 role="progressbar"
                                 data-width="{{ progress_percentage }}"
                                 aria-valuenow="{{ progress_stats.accepted_problems }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="{{ progress_stats.total_problems }}">
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Additional styles for better problem status display */
.badge {
    font-size: 0.75em;
    padding: 0.375em 0.75em;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.breadcrumb {
    margin-bottom: 0;
    background-color: transparent;
    padding: 0;
}

.nav-tabs .nav-link.active {
    font-weight: 600;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.bi {
    vertical-align: -0.125em;
}

.progress {
    background-color: #e9ecef;
    border-radius: 0.25rem;
}

.progress-bar {
    transition: width 0.6s ease;
}

/* Dynamic progress bar styling */
.progress-bar-dynamic {
    width: 0%;
}
</style>

<script>
// Set progress bar width dynamically to avoid CSS parsing issues
document.addEventListener('DOMContentLoaded', function() {
    const progressBar = document.querySelector('.progress-bar-dynamic');
    if (progressBar) {
        const width = progressBar.getAttribute('data-width');
        progressBar.style.width = width + '%';
    }
});
</script>
{% endblock %}