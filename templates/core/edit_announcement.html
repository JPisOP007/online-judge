{% extends 'core/base.html' %}
{% load static %}

{% block title %}Edit Announcement - {{ contest.title }}{% endblock %}

{% block extra_css %}
<style>
  .announcement-form {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 2rem;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
  }

  .announcement-form:hover {
    box-shadow: var(--shadow-lg);
  }

  .form-control {
    border: 2px solid var(--border-color);
    border-radius: 8px;
    padding: 12px 16px;
    transition: all 0.2s ease;
    background: rgba(255, 255, 255, 0.9);
  }

  .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    background: white;
  }

  .form-label {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 8px;
  }

  .btn-group-custom {
    gap: 12px;
  }

  .contest-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #1d4ed8 100%);
    color: white;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
  }

  .breadcrumb-custom {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border-radius: 8px;
    padding: 12px 20px;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
  }

  .breadcrumb-custom a {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 500;
  }

  .breadcrumb-custom a:hover {
    color: #1d4ed8;
    text-decoration: underline;
  }

  .form-help-text {
    font-size: 0.875rem;
    color: var(--secondary-color);
    margin-top: 4px;
  }

  .required-field::after {
    content: " *";
    color: var(--danger-color);
  }

  .announcement-preview {
    background: rgba(248, 250, 252, 0.8);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
  }

  .character-count {
    font-size: 0.8rem;
    color: var(--secondary-color);
    text-align: right;
    margin-top: 4px;
  }

  .character-count.warning {
    color: var(--warning-color);
  }

  .character-count.danger {
    color: var(--danger-color);
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <!-- Breadcrumb -->
  <nav class="breadcrumb-custom">
    <a href="{% url 'contest_detail' contest.uuid %}">{{ contest.title }}</a>
    <span class="mx-2">/</span>
    <a href="{% url 'contest_announcements' contest.uuid %}">Announcements</a>
    <span class="mx-2">/</span>
    <span class="text-muted">Edit Announcement</span>
  </nav>

  <!-- Contest Header -->
  <div class="contest-header">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <h2 class="mb-1">
          <i class="bi bi-megaphone-fill me-2"></i>
          Edit Announcement
        </h2>
        <p class="mb-0 fs-5">{{ contest.title }}</p>
      </div>
      <div class="text-end">
        <div class="contest-status contest-{{ contest.status }}">
          {{ contest.get_status_display }}
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Form -->
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="announcement-form">
        <div class="d-flex align-items-center mb-4">
          <i class="bi bi-pencil-square fs-4 text-primary me-3"></i>
          <div>
            <h4 class="mb-1">Edit Announcement</h4>
            <p class="text-muted mb-0">Update the announcement details for contest participants</p>
          </div>
        </div>

        <form method="post" id="announcementForm">
          {% csrf_token %}
          
          <!-- Title Field -->
          <div class="mb-4">
            <label for="{{ form.title.id_for_label }}" class="form-label required-field">
              <i class="bi bi-type me-1"></i>Title
            </label>
            {{ form.title }}
            {% if form.title.errors %}
              <div class="text-danger mt-1">
                {% for error in form.title.errors %}
                  <small><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</small>
                {% endfor %}
              </div>
            {% endif %}
            <div class="form-help-text">
              <i class="bi bi-info-circle me-1"></i>
              Keep the title concise and descriptive (max 200 characters)
            </div>
            <div class="character-count" id="titleCount">0 / 200</div>
          </div>

          <!-- Content Field -->
          <div class="mb-4">
            <label for="{{ form.content.id_for_label }}" class="form-label required-field">
              <i class="bi bi-file-text me-1"></i>Content
            </label>
            {{ form.content }}
            {% if form.content.errors %}
              <div class="text-danger mt-1">
                {% for error in form.content.errors %}
                  <small><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</small>
                {% endfor %}
              </div>
            {% endif %}
            <div class="form-help-text">
              <i class="bi bi-info-circle me-1"></i>
              Provide clear and detailed information. You can use line breaks for better formatting.
            </div>
            <div class="character-count" id="contentCount">0 / 2000</div>
          </div>

          <!-- Priority Field -->
          <div class="mb-4">
            <label for="{{ form.priority.id_for_label }}" class="form-label">
              <i class="bi bi-flag me-1"></i>Priority
            </label>
            {{ form.priority }}
            {% if form.priority.errors %}
              <div class="text-danger mt-1">
                {% for error in form.priority.errors %}
                  <small><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</small>
                {% endfor %}
              </div>
            {% endif %}
            <div class="form-help-text">
              <i class="bi bi-info-circle me-1"></i>
              High priority announcements will be highlighted to participants
            </div>
          </div>

          <!-- Preview Section -->
          <div class="mb-4">
            <h6 class="form-label">
              <i class="bi bi-eye me-1"></i>Preview
            </h6>
            <div class="announcement-preview" id="announcementPreview">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-flag-fill text-primary me-2" id="previewPriorityIcon"></i>
                <strong id="previewTitle">{{ announcement.title }}</strong>
              </div>
              <div id="previewContent">{{ announcement.content|linebreaks }}</div>
              <small class="text-muted">
                <i class="bi bi-clock me-1"></i>
                Last updated: {{ announcement.created_at|date:"M d, Y H:i" }}
              </small>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex justify-content-between btn-group-custom">
            <div>
              <a href="{% url 'contest_announcements' contest.uuid %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Cancel
              </a>
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-primary" id="previewBtn">
                <i class="bi bi-eye me-1"></i>Update Preview
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg me-1"></i>Update Announcement
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Back to Announcements -->
  <div class="text-center mt-4">
    <a href="{% url 'contest_announcements' contest.uuid %}" class="btn btn-outline-primary">
      <i class="bi bi-list me-1"></i>View All Announcements
    </a>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const titleInput = document.getElementById('{{ form.title.id_for_label }}');
    const contentInput = document.getElementById('{{ form.content.id_for_label }}');
    const prioritySelect = document.getElementById('{{ form.priority.id_for_label }}');
    const titleCount = document.getElementById('titleCount');
    const contentCount = document.getElementById('contentCount');
    const previewTitle = document.getElementById('previewTitle');
    const previewContent = document.getElementById('previewContent');
    const previewPriorityIcon = document.getElementById('previewPriorityIcon');
    const previewBtn = document.getElementById('previewBtn');

    // Character counting function
    function updateCharCount(input, counter, maxLength) {
        const currentLength = input.value.length;
        counter.textContent = `${currentLength} / ${maxLength}`;
        
        if (currentLength > maxLength * 0.9) {
            counter.classList.add('warning');
            counter.classList.remove('danger');
        }
        if (currentLength >= maxLength) {
            counter.classList.add('danger');
            counter.classList.remove('warning');
        }
        if (currentLength < maxLength * 0.9) {
            counter.classList.remove('warning', 'danger');
        }
    }

    // Update preview function
    function updatePreview() {
        previewTitle.textContent = titleInput.value || 'Announcement Title';
        previewContent.innerHTML = contentInput.value.replace(/\n/g, '<br>') || 'Announcement content will appear here...';
        
        // Update priority icon
        const priority = prioritySelect.value;
        previewPriorityIcon.className = 'bi bi-flag-fill me-2';
        
        if (priority === 'high') {
            previewPriorityIcon.classList.add('text-danger');
        } else if (priority === 'medium') {
            previewPriorityIcon.classList.add('text-warning');
        } else {
            previewPriorityIcon.classList.add('text-primary');
        }
    }

    // Event listeners
    titleInput.addEventListener('input', function() {
        updateCharCount(this, titleCount, 200);
        updatePreview();
    });

    contentInput.addEventListener('input', function() {
        updateCharCount(this, contentCount, 2000);
        updatePreview();
    });

    prioritySelect.addEventListener('change', updatePreview);
    previewBtn.addEventListener('click', updatePreview);

    // Initialize character counts and preview
    updateCharCount(titleInput, titleCount, 200);
    updateCharCount(contentInput, contentCount, 2000);
    updatePreview();

    // Form validation
    document.getElementById('announcementForm').addEventListener('submit', function(e) {
        if (!titleInput.value.trim()) {
            e.preventDefault();
            titleInput.focus();
            alert('Please enter a title for the announcement.');
            return false;
        }
        
        if (!contentInput.value.trim()) {
            e.preventDefault();
            contentInput.focus();
            alert('Please enter content for the announcement.');
            return false;
        }
        
        if (titleInput.value.length > 200) {
            e.preventDefault();
            titleInput.focus();
            alert('Title must be 200 characters or less.');
            return false;
        }
        
        if (contentInput.value.length > 2000) {
            e.preventDefault();
            contentInput.focus();
            alert('Content must be 2000 characters or less.');
            return false;
        }
    });

    // Auto-resize textarea
    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    contentInput.addEventListener('input', function() {
        autoResize(this);
    });

    // Initial resize
    autoResize(contentInput);
});
</script>
{% endblock %}